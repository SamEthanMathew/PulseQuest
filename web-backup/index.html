<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <title>PulseQuest</title>
  <style>
    :root {
      --card: rgba(255, 255, 255, 0.06);
      --card2: rgba(255, 255, 255, 0.09);
      --stroke: rgba(255, 255, 255, 0.12);
      --text: rgba(255, 255, 255, 0.92);
      --muted: rgba(255, 255, 255, 0.65);
      --good: #2ee59d;
      --warn: #ff5c5c;
      --beacon: #ffd166;
      --accent: #6ca8ff;
      --empty: #0d2a3a;
      --wall: #151525;
      --hazard: #3a1515;
      --beaconBg: #2a2510;

      /* Safe area support for notched devices */
      --sat: env(safe-area-inset-top, 0px);
      --sar: env(safe-area-inset-right, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    /* Mobile-first optimizations */
    html,
    body {
      width: 100%;
      height: 100vh;
      /* Fallback */
      height: 100dvh;
      /* Dynamic viewport - handles address bar */
      margin: 0;
      padding: 0;
      overflow: hidden;
      /* Prevent scrolling during gameplay */
      position: fixed;
      /* Lock viewport */
      overscroll-behavior: none;
      touch-action: none;
      /* Prevent default gestures */
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none;
      user-select: none;
    }

    body {
      min-height: 100vh;
      min-height: 100dvh;
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(ellipse at 50% 30%, #0a1628 0%, #070A16 50%, #030508 100%)
    }

    .shell {
      max-width: 900px;
      width: 100%;
      height: 100vh;
      height: 100dvh;
      margin: 0 auto;
      padding: max(12px, var(--sat)) max(12px, var(--sar)) max(12px, var(--sab)) max(12px, var(--sal));
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      overflow: hidden;
      touch-action: manipulation;
      -webkit-user-select: none;
      user-select: none;
    }

    .card {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 20px;
      box-shadow: 0 20px 70px rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(12px);
      overflow: hidden;
      /* Important to clip the grid if it overflows */
      position: relative;
    }

    /* HUD */
    .hud {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      border-bottom: 1px solid var(--stroke)
    }

    .hud .title {
      font-weight: 800;
      font-size: 18px;
      color: var(--beacon)
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: var(--card2);
      color: var(--muted);
      font-size: 12px
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--warn)
    }

    .dot.ok {
      background: var(--good);
      box-shadow: 0 0 12px rgba(46, 229, 157, 0.6);
      animation: pulse 2s infinite
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: 0.5
      }
    }

    .chips {
      display: flex;
      gap: 6px
    }

    /* Objective */
    .objective {
      text-align: center;
      padding: 10px;
      font-size: 14px;
      color: var(--muted);
      border-bottom: 1px solid var(--stroke)
    }

    .objective strong {
      color: var(--beacon);
      font-size: 16px
    }

    /* Stage */
    .stage {
      flex: 1;
      min-height: 0;
      padding: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      touch-action: none;
      /* Crucial for pointer events */
    }

    #grid {
      display: grid;
      grid-template-columns: repeat(21, 1fr);
      gap: 1px;
      padding: 6px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 12px;
      border: 1px solid var(--stroke);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      position: relative;
      max-width: 100%;
      aspect-ratio: 21 / 7
    }

    .cell {
      width: 100%;
      aspect-ratio: 1;
      max-width: 36px;
      max-height: 36px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      transition: all 0.3s;
      border: 1px solid transparent
    }

    /* Tile types with icons */
    .cell.E {
      background: var(--empty);
      border-color: rgba(46, 229, 157, 0.12)
    }

    .cell.W {
      background: var(--wall);
      border-color: rgba(255, 255, 255, 0.08);
      background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(255, 255, 255, 0.03) 5px, rgba(255, 255, 255, 0.03) 10px)
    }

    .cell.H {
      background: var(--hazard);
      border-color: rgba(255, 92, 92, 0.25)
    }

    .cell.B {
      background: var(--beaconBg);
      border-color: rgba(255, 209, 102, 0.35)
    }

    /* Icons */
    .icon {
      font-size: 18px;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
      transition: opacity 0.3s
    }

    .cell.fog .icon {
      opacity: 0.08
    }

    .cell.W .icon {
      opacity: 0.4
    }

    /* Player glow - always visible */
    .player {
      font-size: 20px;
      color: #fff;
      filter: drop-shadow(0 0 8px var(--accent)) drop-shadow(0 0 16px var(--accent));
      z-index: 5;
      animation: playerGlow 1.5s infinite
    }

    @keyframes playerGlow {

      0%,
      100% {
        filter: drop-shadow(0 0 12px var(--accent)) drop-shadow(0 0 24px var(--accent))
      }

      50% {
        filter: drop-shadow(0 0 18px var(--accent)) drop-shadow(0 0 36px var(--accent))
      }
    }

    /* Beacon pulse - intense */
    .cell.B::after {
      content: "";
      position: absolute;
      inset: -4px;
      border-radius: 14px;
      box-shadow: 0 0 30px rgba(255, 209, 102, 0.7), 0 0 60px rgba(255, 209, 102, 0.4), inset 0 0 20px rgba(255, 209, 102, 0.3);
      animation: beaconPulse 0.8s infinite;
      pointer-events: none
    }

    @keyframes beaconPulse {

      0%,
      100% {
        opacity: 0.5;
        transform: scale(0.95);
        box-shadow: 0 0 30px rgba(255, 209, 102, 0.7), 0 0 60px rgba(255, 209, 102, 0.4)
      }

      50% {
        opacity: 1;
        transform: scale(1.08);
        box-shadow: 0 0 50px rgba(255, 209, 102, 1), 0 0 100px rgba(255, 209, 102, 0.6), 0 0 150px rgba(255, 209, 102, 0.3)
      }
    }

    /* Hazard shimmer */
    .cell.H::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 10px;
      background: radial-gradient(circle at 30% 30%, rgba(255, 100, 100, 0.2), transparent 50%), radial-gradient(circle at 70% 70%, rgba(255, 100, 100, 0.15), transparent 40%);
      animation: hazardShimmer 0.8s infinite alternate
    }

    @keyframes hazardShimmer {
      0% {
        opacity: 0.5
      }

      100% {
        opacity: 1
      }
    }

    /* Fog */
    .cell.fog {
      opacity: 0.15;
      filter: blur(2px)
    }

    .cell.scan {
      animation: scanFlash 0.6s
    }

    @keyframes scanFlash {
      0% {
        box-shadow: 0 0 0 4px var(--accent), 0 0 20px var(--accent)
      }

      100% {
        box-shadow: none
      }
    }

    /* Ping ring */
    .ping {
      position: absolute;
      border-radius: 50%;
      border: 2px solid var(--accent);
      opacity: 0;
      pointer-events: none;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%)
    }

    .ping.active {
      animation: pingExpand 0.8s ease-out forwards
    }

    @keyframes pingExpand {
      0% {
        width: 30px;
        height: 30px;
        opacity: 0.9
      }

      100% {
        width: 280px;
        height: 280px;
        opacity: 0
      }
    }

    /* Haptic strip */
    #haptics {
      height: 24px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 6px;
      display: flex;
      gap: 2px;
      padding: 3px;
      width: 100%;
      max-width: 380px;
      border: 1px solid var(--stroke)
    }

    .hpulse {
      flex: 0 0 32px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      transition: all 0.15s
    }

    .hpulse.on {
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent)
    }

    /* Controls dock */
    /* Drawer Styling - Full Overlay */
    .drawer {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      width: 280px;
      background: rgba(10, 15, 30, 0.98);
      border-left: 1px solid var(--stroke);
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      display: flex;
      flex-direction: column;
      padding: 0;
      backdrop-filter: blur(24px);
      box-shadow: -20px 0 50px rgba(0, 0, 0, 0.8);
    }

    .drawer.open {
      transform: translateX(0);
    }

    .drawer-header {
      padding: 24px 20px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .drawer h3 {
      font-size: 20px;
      color: var(--beacon);
      font-weight: 800;
      margin: 0;
    }

    .drawer .settings {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 14px;
      padding: 20px;
      overflow-y: auto;
    }

    .drawer .settings label,
    .drawer .settings select,
    .drawer .settings button {
      width: 100%;
      text-align: left;
      font-size: 14px;
      background: rgba(255, 255, 255, 0.05);
      padding: 14px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }

    .drawer .close-btn {
      background: rgba(255, 255, 255, 0.05);
      border: none;
      color: #fff;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Fullscreen Game Layout */
    .stage {
      flex: 1;
      padding: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      touch-action: none;
      background: rgba(0, 0, 0, 0.2);
    }

    #grid {
      width: 100%;
      max-width: 100%;
      max-height: 100%;
      aspect-ratio: 21 / 7;
      display: grid;
      grid-template-columns: repeat(21, 1fr);
      gap: 1px;
      padding: 4px;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid var(--stroke);
      border-radius: 12px;
    }

    /* Overlay */
    #overlay {
      position: fixed;
      inset: 0;
      background: rgba(7, 10, 22, 0.92);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100
    }

    #overlay h2 {
      color: var(--beacon);
      font-size: 32px;
      margin-bottom: 12px;
      text-shadow: 0 0 40px rgba(255, 209, 102, 0.5)
    }

    #overlay .subtitle {
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--text)
    }

    #overlay p {
      color: var(--muted);
      font-size: 14px
    }

    #overlay.hidden {
      display: none
    }

    /* Win screen */
    #win {
      position: fixed;
      inset: 0;
      background: rgba(7, 10, 22, 0.97);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100
    }

    #win h2 {
      color: var(--beacon);
      font-size: 56px;
      text-shadow: 0 0 50px rgba(255, 209, 102, 0.6);
      animation: beaconPulse 1s infinite
    }

    #win p {
      color: var(--muted);
      margin-top: 16px;
      font-size: 16px
    }

    #win.hidden {
      display: none
    }

    /* Tablet/Desktop Tweaks */
    @media (min-width: 700px) {
      .drawer {
        width: 340px;
      }
    }

    .tap-hint {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.6);
      padding: 8px 16px;
      border-radius: 99px;
      font-size: 13px;
      color: var(--muted);
      pointer-events: none;
      white-space: nowrap;
      border: 1px solid var(--stroke);
      z-index: 10;
      transition: all 0.2s;
    }

    .tap-hint.active {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 0 20px var(--accent);
    }

    .input-flash {
      position: fixed;
      width: 60px;
      height: 60px;
      background: rgba(108, 168, 255, 0.6);
      border-radius: 50%;
      pointer-events: none;
      z-index: 2000;
      transform: translate(-50%, -50%) scale(0);
      animation: flashIn 0.4s ease-out forwards;
    }

    @keyframes flashIn {
      0% {
        transform: translate(-50%, -50%) scale(0.4);
        opacity: 1;
      }

      100% {
        transform: translate(-50%, -50%) scale(2);
        opacity: 0;
      }
    }

    /* Debug Log Styling */
    .drawer-info {
      padding: 16px;
      font-size: 13px;
      line-height: 1.6;
      color: var(--muted);
      border-top: 1px solid var(--stroke);
      background: rgba(0, 0, 0, 0.2);
    }

    .debug-stat {
      color: var(--accent);
      font-weight: 700;
      font-family: monospace;
    }

    /* Cleanup Landscape Orientation CSS */
    @media (orientation: landscape) {
      .shell {
        flex-direction: column;
        /* Keep vertical for simplicity with drawer */
      }

      .card {
        flex-direction: column;
      }

      .hud {
        writing-mode: horizontal-tb;
        min-width: 0;
        border-right: none;
        border-bottom: 1px solid var(--stroke);
      }

      .chips {
        flex-direction: row;
      }

      .objective {
        position: static;
        font-size: 13px;
        padding: 8px;
      }

      .drawer {
        width: 300px;
        /* Slightly wider in landscape */
      }
    }

    /* Portrait mode (fallback) */
    @media (orientation: portrait) {
      .objective strong {
        font-size: 14px
      }
    }

    /* Small height optimization (works in both orientations) */
    @media (max-height: 450px) {
      .shell {
        padding: 4px
      }

      .hud {
        padding: 6px 8px;
        font-size: 12px
      }

      .hud .title {
        font-size: 12px
      }

      .objective {
        padding: 4px;
        font-size: 10px
      }

      .objective strong {
        font-size: 11px
      }

      .stage {
        padding: 2px
      }

      #grid {
        padding: 3px;
        gap: 1px
      }

      .cell {
        border-radius: 2px
      }

      .icon {
        font-size: 12px
      }

      .controls {
        padding: 4px 6px
      }

      .dock {
        gap: 3px;
        padding: 4px
      }

      .btn {
        min-width: 45px;
        padding: 6px 8px;
        font-size: 10px
      }

      .settings {
        padding: 4px;
        gap: 3px
      }

      .settings label,
      .settings select,
      .settings button {
        font-size: 9px;
        padding: 3px 6px
      }
    }

    /* Prevent text selection during touch */
    .stage,
    .grid,
    .cell,
    .dock,
    .btn {
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none
    }
  </style>
</head>

<body>
  <!-- Debug viewport info (toggle with Shift+D) -->
  <div id="debug"
    style="display:none; position:fixed; top:0; left:0; background:rgba(0,0,0,0.9); color:#0f0; font-family:monospace; font-size:10px; padding:8px; z-index:999; max-width:200px; line-height:1.3; pointer-events:none;">
    <div id="debug-content"></div>
  </div>

  <div class="shell">
    <div class="card">
      <div class="hud">
        <div class="title">‚üÅ PulseQuest</div>
        <div class="chips">
          <div class="pill">‚öì <span id="steps">0</span> steps</div>
          <button class="menu-toggle" onclick="togDrawer()"
            style="background:var(--card2); border:1px solid var(--stroke); color:var(--text); padding:8px 12px; border-radius:8px; cursor:pointer; font-size:14px;">‚öôÔ∏è
            Settings</button>
        </div>
      </div>
      <div class="objective">
        <strong id="msg">üóº Find the Beacon</strong> ‚Äî Navigate by touch
      </div>
      <div class="stage" id="stage">
        <div id="grid"></div>
        <div id="ping" class="ping"></div>
        <div class="tap-hint" id="hint">Tap Left: Move ‚Ä¢ Right: Turn ‚Ä¢ Hold: Scan</div>
      </div>

      <!-- Settings Drawer -->
      <div id="drawer" class="drawer">
        <div class="drawer-header">
          <h3>Settings</h3>
          <button class="close-btn" onclick="togDrawer()">√ó</button>
        </div>
        <div class="settings">
          <label><input type="checkbox" id="specV" checked onchange="render()">Spectator View</label>
          <label><input type="checkbox" id="demoM" onchange="togDemo()">Demo Assistant</label>
          <label><input type="checkbox" id="muteAudio" onchange="setVolume(this.checked?0:0.4)">Mute Sounds</label>
          <select id="lvl" onchange="loadLvl()">
            <option value="0">Level: Tutorial</option>
            <option value="1">Level: Hazards</option>
            <option value="2">Level: Challenge</option>
          </select>
          <button onclick="togTrain()">üõ†Ô∏è Training Sandbox</button>

          <div id="train" style="max-height: 0; overflow: hidden; transition: max-height 0.3s;">
            <div class="train-inner" style="padding: 10px 0; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
              <button onclick="hapticImpact('light');playMove()" style="font-size: 11px;">üåä Empty</button>
              <button onclick="hapticNotify('error');playWall()" style="font-size: 11px;">üß± Wall</button>
              <button onclick="hapticNotify('success');playWin()" style="font-size: 11px;">üóº Beacon</button>
              <button onclick="playSonar()" style="font-size: 11px;">üì° Sonar</button>
            </div>
          </div>
        </div>
        <div class="drawer-info" id="debug-monitor">
          <div>Status: <span id="dbg-status" class="debug-stat">STOPPED</span></div>
          <div>Pos: <span id="dbg-pos" class="debug-stat">1,1</span></div>
          <div>Dir: <span id="dbg-dir" class="debug-stat">E</span></div>
          <div>Last: <span id="dbg-act" class="debug-stat">None</span></div>
          <div style="margin-top:8px; font-size:10px; opacity:0.5;">Logic: index.html + js/*.js</div>
        </div>
      </div>
    </div>
  </div>

  <div id="overlay" onclick="start()" ontouchend="start()">
    <h2>‚üÅ PulseQuest</h2>
    <div class="subtitle">‚õµ Navigate ‚Ä¢ üóº Find beacon</div>
    <p>Tap to begin</p>
  </div>
  <div id="win" class="hidden">
    <h2>üèÜ</h2>
    <p>Beacon found! Press Enter to play again</p>
  </div>

  <script src="js/no-network-guard.js"></script>
  <script src="js/haptics.js"></script>
  <script src="js/audio.js"></script>

  <script>
    const LEVELS = [
      "WWWWWWWWWWWWWWWWWWWWW,WEEEEEWWWWWEEEEEEEWW,WEWWWEWWWWWEWWWWWEWW,WEWWWEEEEEEEWWWWWEWW,WEWWWWWWWWWWWEEEEEWW,WEEEEEEEEEEEEEWWWBEW,WWWWWWWWWWWWWWWWWWWWW",
      "WWWWWWWWWWWWWWWWWWWWW,WEEEEEWEEEWEEEEEEEEWW,WEWWWEWWWWWEWWWWWEWW,WEWWWEEEEEEEWWWWWEWW,WEWWWWWWWWWWWEEEEEWW,WEEEEEEEEEEEEEWWWBEW,WWWWWWWWWWWWWWWWWWWWW",
      "WWWWWWWWWWWWWWWWWWWWW,WEEEEEWEEEWEEEEEEEEWW,WEWWWEWWWWWEWEWWWEWW,WEEWEWEEEEEEEWWWBEWW,WEWWWWWWWWWWWEEEWEWW,WEEEEEEEEEEEEEEEEEWW,WWWWWWWWWWWWWWWWWWWWW"
    ];
    const DIR = ['N', 'E', 'S', 'W'], DX = [0, 1, 0, -1], DY = [-1, 0, 1, 0], ARR = ['‚ñ≤', '‚ñ∫', '‚ñº', '‚óÄ'];
    const ICONS = { E: '', W: 'üß±', B: 'üóº' };
    let map, px, py, pd, steps, lastScan, started = false;

    function parse(s) { return s.split(',').map(r => r.split('')) }
    function loadLvl() {
      const i = +document.getElementById('lvl').value;
      map = parse(LEVELS[i]); px = 1; py = 1; pd = 1; steps = 0; lastScan = null;
      document.getElementById('win').classList.add('hidden');
      render(); updStats();
    }
    function tile(x, y) { return (y >= 0 && y < 7 && x >= 0 && x < 21) ? map[y][x] : 'W' }
    function ahead() { return { x: px + DX[pd], y: py + DY[pd] } }
    function leftT() { const d = (pd + 3) % 4; return { x: px + DX[d], y: py + DY[d] } }
    function rightT() { const d = (pd + 1) % 4; return { x: px + DX[d], y: py + DY[d] } }

    function render() {
      const g = document.getElementById('grid'), spec = document.getElementById('specV').checked;
      g.innerHTML = '';
      for (let y = 0; y < 7; y++)for (let x = 0; x < 21; x++) {
        const c = document.createElement('div');
        const t = map[y][x];
        c.className = 'cell ' + t;
        const dist = Math.abs(x - px) + Math.abs(y - py);
        if (!spec && dist > 2) c.classList.add('fog');

        // Add icon
        if (x === px && y === py) {
          c.innerHTML = `<span class="player">${ARR[pd]}</span>`;
        } else if (ICONS[t]) {
          c.innerHTML = `<span class="icon">${ICONS[t]}</span>`;
        }
        g.appendChild(c);
      }
    }
    function updStats() {
      document.getElementById('steps').textContent = steps;
    }
    function flash(coords) {
      const cells = document.querySelectorAll('.cell');
      coords.forEach(([x, y]) => { if (x >= 0 && x < 21 && y >= 0 && y < 7) cells[y * 21 + x].classList.add('scan') });
      // Ping animation
      const ping = document.getElementById('ping');
      if (ping) {
        ping.classList.remove('active');
        void ping.offsetWidth;
        ping.classList.add('active');
      }
      setTimeout(() => { cells.forEach(c => c.classList.remove('scan')) }, 600);
    }



    function act(a) {
      if (!started) return;
      if (a === 'M') {
        const { x, y } = ahead(), t = tile(x, y);
        if (t === 'W') { log("Hit Wall"); hapticNotify('error'); playWall(); return; }
        px = x; py = y; steps++;
        log(`Moved to ${px},${py}`);
        if (t === 'E') { hapticImpact('light'); playMove(); }
        if (t === 'B') { hapticNotify('success'); playWin(); document.getElementById('win').classList.remove('hidden'); }
      } else if (a === 'L') { pd = (pd + 3) % 4; log("Turned Left"); hapticSelection(); playTurn(); }
      else if (a === 'R') { pd = (pd + 1) % 4; log("Turned Right"); hapticSelection(); playTurn(); }
      else if (a === 'S') {
        const f = tile(ahead().x, ahead().y), l = tile(leftT().x, leftT().y), r = tile(rightT().x, rightT().y);
        lastScan = { f, l, r };
        hapticImpact('medium'); playSonar();
        flash([[ahead().x, ahead().y], [leftT().x, leftT().y], [rightT().x, rightT().y]]);
      } else if (a === 'P') {
        hapticImpact('light'); playSonar();
      }
      render(); updStats();
    }

    function updStats() {
      const s = document.getElementById('steps');
      if (s) s.textContent = steps;

      const statusEl = document.getElementById('dbg-status');
      if (statusEl) statusEl.textContent = started ? 'RUNNING' : 'STOPPED';

      const posEl = document.getElementById('dbg-pos');
      if (posEl) posEl.textContent = `${px},${py}`;

      const dirEl = document.getElementById('dbg-dir');
      if (dirEl) dirEl.textContent = DIR[pd];
    }

    function log(m) {
      const actEl = document.getElementById('dbg-act');
      if (actEl) actEl.textContent = m;
      console.log("Game Event:", m);
    }

    const logAct = log; // Compatibility alias

    function start() { document.getElementById('overlay').classList.add('hidden'); started = true; loadLvl(); }
    function togTrain() {
      const t = document.getElementById('train');
      t.classList.toggle('open');
    }

    function togDrawer() {
      const d = document.getElementById('drawer');
      d.classList.toggle('open');
    }

    function togDemo() {
      const d = document.getElementById('demoM').checked;
      document.getElementById('specV').checked = d;
      document.getElementById('msg').innerHTML = d ? '<strong style="font-size:22px">Press SCAN ‚Üí then MOVE</strong>' : '<strong>üóº Find the Beacon</strong> ‚Äî Navigate by touch';
      render();
    }

    // Distance scan with logarithmic vibration
    function performDistanceScan() {
      let beaconX = 19;
      let beaconY = 5;

      // Find actual beacon position
      for (let y = 0; y < 7; y++) {
        for (let x = 0; x < 21; x++) {
          if (map[y][x] === 'B') {
            beaconX = x;
            beaconY = y;
            break;
          }
        }
      }

      // Calculate straight-line distance (hypotenuse)
      const dx = beaconX - px;
      const dy = beaconY - py;
      const distance = Math.sqrt(dx * dx + dy * dy);

      // Logarithmic vibration: closer = longer buzz
      // Max distance ~25 units, map to 100-800ms range
      const maxDist = 25;
      const minVibDuration = 100;  // Very far = short buzz
      const maxVibDuration = 800;  // Very close = long buzz

      // Inverse logarithmic mapping (closer = more vibration)
      const normalizedDist = Math.min(distance / maxDist, 1);
      const vibDuration = maxVibDuration - (Math.log(1 + normalizedDist * 9) / Math.log(10)) * (maxVibDuration - minVibDuration);

      // Visual flash effect
      flash([[px, py]]);

      // Haptic feedback
      if (navigator.vibrate) {
        navigator.vibrate(Math.round(vibDuration));
      } else {
        // Audio fallback
        hapticImpact('medium');
      }

      // Optional: Audio ping
      playSonar();

      console.log(`Distance to beacon: ${distance.toFixed(1)} units, vibration: ${Math.round(vibDuration)}ms`);
    }

    // Simplified Input Logic
    let activePointers = new Map();
    let leftTouch = false, rightTouch = false, touchTimeout = null, wasHeld = false;

    function logInput(m) {
      const actEl = document.getElementById('dbg-act');
      if (actEl) actEl.textContent = m;
      console.log("Input Event:", m);
    }

    function showFlash(x, y) {
      const f = document.createElement('div');
      f.className = 'input-flash';
      f.style.left = x + 'px';
      f.style.top = y + 'px';
      document.body.appendChild(f);
      setTimeout(() => f.remove(), 400);
    }

    function updateTouchZones() {
      const stage = document.getElementById('stage');
      const rect = stage.getBoundingClientRect();
      const mid = rect.left + rect.width / 2;

      leftTouch = false; rightTouch = false;
      activePointers.forEach(x => {
        if (x < mid) leftTouch = true;
        else rightTouch = true;
      });

      const hint = document.getElementById('hint');
      if (hint) hint.classList.toggle('active', leftTouch || rightTouch);
    }

    // Attach to the stage for better precision with pointer capture
    const stageEl = document.getElementById('stage');

    stageEl.addEventListener('pointerdown', e => {
      if (!started || e.target.closest('#drawer') || e.target.closest('.menu-toggle')) return;

      e.preventDefault();
      stageEl.setPointerCapture(e.pointerId);

      wasHeld = false;
      activePointers.set(e.pointerId, e.clientX);
      updateTouchZones();
      showFlash(e.clientX, e.clientY);

      const rect = stageEl.getBoundingClientRect();
      const isLeft = e.clientX < (rect.left + rect.width / 2);
      logInput(`Down: ${isLeft ? 'LEFT' : 'RIGHT'}`);

      if (leftTouch && rightTouch) {
        clearTimeout(touchTimeout);
        touchTimeout = setTimeout(() => { wasHeld = true; performDistanceScan(); logInput("Triggered SCAN"); }, 300);
      }
    }, { passive: false });

    document.addEventListener('pointerup', e => {
      if (!activePointers.has(e.pointerId)) return;

      // Release pointer capture if we had it
      try { stageEl.releasePointerCapture(e.pointerId); } catch { }

      const rect = stageEl.getBoundingClientRect();
      const mid = rect.left + rect.width / 2;
      const startX = activePointers.get(e.pointerId);

      activePointers.delete(e.pointerId);
      clearTimeout(touchTimeout);

      if (activePointers.size === 0 && !wasHeld) {
        if (startX < mid) {
          act('M');
        } else {
          act('R');
        }
      }
      updateTouchZones();
    });

    document.addEventListener('pointercancel', e => {
      try { stageEl.releasePointerCapture(e.pointerId); } catch { }
      activePointers.delete(e.pointerId);
      updateTouchZones();
      clearTimeout(touchTimeout);
    });

    // Compatibility for start overlay (mouse/touch)
    document.getElementById('overlay').addEventListener('pointerdown', start);

    document.addEventListener('keydown', e => {
      // Toggle debug with Shift+D
      if (e.key === 'D' && e.shiftKey) {
        debugVisible = !debugVisible;
        debugEl.style.display = debugVisible ? 'block' : 'none';
        if (debugVisible) updateDebug();
        return;
      }

      if (e.key === 'Enter') { if (!started) start(); else loadLvl(); return; }
      const k = { w: 'M', arrowup: 'M', a: 'L', arrowleft: 'L', d: 'R', arrowright: 'R', s: 'S', shift: 'S', r: 'P' }[e.key.toLowerCase()];
      if (k) act(k);
    });

    // Viewport debug readout (Shift+D to toggle)
    let debugVisible = false;
    const debugEl = document.getElementById('debug');
    const debugContent = document.getElementById('debug-content');

    function updateDebug() {
      if (!debugVisible) return;

      const getInset = (side) => {
        const val = getComputedStyle(document.documentElement)
          .getPropertyValue(`--sa${side}`);
        return val || '0px';
      };

      debugContent.innerHTML = `
W: ${window.innerWidth}px
H: ${window.innerHeight}px
DPR: ${window.devicePixelRatio}
Orient: ${screen.orientation?.type || 'unknown'}
SAT: ${getInset('t')}
SAR: ${getInset('r')}
SAB: ${getInset('b')}
SAL: ${getInset('l')}
Grid: ${document.getElementById('grid')?.offsetWidth || 0}√ó${document.getElementById('grid')?.offsetHeight || 0}
      `.trim();
    }

    // Update debug on resize
    window.addEventListener('resize', updateDebug);
    window.addEventListener('orientationchange', () => {
      setTimeout(updateDebug, 300); // Wait for layout
    });

    loadLvl();
  </script>
</body>

</html>