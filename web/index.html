<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>‚üÅ PulseQuest</title>
  <style>
    :root {
      --bg: #070a16;
      --card: #0f1420;
      --text: #e8edf5;
      --stroke: #1e2738;
      --accent: #6ca8ff;
      --beacon: #ffd166;
      --empty: #1a2332;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow: hidden;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .shell {
      width: 100%;
      height: 100%;
      max-width: 900px;
      max-height: 700px;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }

    .card {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 20px;
      overflow: hidden;
      position: relative;
    }

    .hud {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--stroke);
      background: rgba(0, 0, 0, 0.2);
    }

    .title {
      font-size: 20px;
      font-weight: 800;
      color: var(--beacon);
    }

    .info {
      font-size: 14px;
      color: var(--text);
    }

    .stage {
      flex: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      touch-action: none;
    }

    #grid {
      width: 100%;
      max-width: 100%;
      max-height: 100%;
      aspect-ratio: 21 / 7;
      display: grid;
      grid-template-columns: repeat(21, 1fr);
      gap: 1px;
      padding: 4px;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid var(--stroke);
      border-radius: 12px;
    }

    .cell {
      width: 100%;
      aspect-ratio: 1;
      max-width: 36px;
      max-height: 36px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      background: var(--empty);
      border: 1px solid rgba(46, 229, 157, 0.12);
    }

    .cell.beacon {
      background: #3d2f1a;
      border-color: rgba(255, 209, 102, 0.35);
    }

    .cell.wall {
      background: #2a3142;
      border-color: rgba(255, 255, 255, 0.08);
    }

    .player {
      font-size: 18px;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
    }

    .icon {
      font-size: 18px;
    }

    /* Compass */
    .compass {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 80px;
      height: 80px;
      background: rgba(0, 0, 0, 0.5);
      border: 2px solid var(--stroke);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .compass-inner {
      position: relative;
      width: 60px;
      height: 60px;
    }

    .compass-arrow {
      position: absolute;
      font-size: 16px;
      opacity: 0.3;
      transition: opacity 0.3s, transform 0.3s;
    }

    .compass-arrow.active {
      opacity: 1;
      color: #ffd166;
      transform: scale(1.3);
      filter: drop-shadow(0 0 8px #ffd166);
    }

    .compass-arrow.n {
      top: 0;
      left: 50%;
      transform: translateX(-50%);
    }

    .compass-arrow.n.active {
      transform: translateX(-50%) scale(1.3);
    }

    .compass-arrow.e {
      top: 50%;
      right: 0;
      transform: translateY(-50%);
    }

    .compass-arrow.e.active {
      transform: translateY(-50%) scale(1.3);
    }

    .compass-arrow.s {
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
    }

    .compass-arrow.s.active {
      transform: translateX(-50%) scale(1.3);
    }

    .compass-arrow.w {
      top: 50%;
      left: 0;
      transform: translateY(-50%);
    }

    .compass-arrow.w.active {
      transform: translateY(-50%) scale(1.3);
    }

    /* Settings Drawer */
    .drawer {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      width: 280px;
      background: rgba(10, 15, 30, 0.98);
      border-left: 1px solid var(--stroke);
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(24px);
      box-shadow: -20px 0 50px rgba(0, 0, 0, 0.8);
    }

    .drawer.open {
      transform: translateX(0);
    }

    .drawer-header {
      padding: 24px 20px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .drawer h3 {
      font-size: 20px;
      color: var(--beacon);
      font-weight: 800;
      margin: 0;
    }

    .close-btn {
      background: rgba(255, 255, 255, 0.05);
      border: none;
      color: #fff;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .settings {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 14px;
      padding: 20px;
      overflow-y: auto;
    }

    .settings label,
    .settings select {
      width: 100%;
      text-align: left;
      font-size: 14px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }

    .settings select:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.06));
      border-color: var(--accent);
      transform: translateY(-1px);
    }

    .settings select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(108, 168, 255, 0.1);
    }

    .settings select option {
      background: #0f1420;
      color: var(--text);
      padding: 10px;
    }

    .menu-btn {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
      border: 1px solid var(--stroke);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .menu-btn:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.06));
      border-color: var(--accent);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .menu-btn:active {
      transform: translateY(0);
    }

    .tap-hint {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.6);
      padding: 8px 16px;
      border-radius: 99px;
      font-size: 13px;
      color: #aaa;
      pointer-events: none;
      border: 1px solid var(--stroke);
    }

    .input-flash {
      position: fixed;
      width: 60px;
      height: 60px;
      background: rgba(108, 168, 255, 0.6);
      border-radius: 50%;
      pointer-events: none;
      z-index: 2000;
      transform: translate(-50%, -50%) scale(0);
      animation: flashIn 0.4s ease-out forwards;
    }

    @keyframes flashIn {
      0% {
        transform: translate(-50%, -50%) scale(0.4);
        opacity: 1;
      }

      100% {
        transform: translate(-50%, -50%) scale(2);
        opacity: 0;
      }
    }

    #overlay {
      position: absolute;
      inset: 0;
      background: rgba(7, 10, 22, 0.95);
      backdrop-filter: blur(20px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      cursor: pointer;
    }

    #overlay.hidden {
      display: none;
    }

    #overlay h2 {
      font-size: 48px;
      margin-bottom: 10px;
      color: var(--beacon);
    }

    #overlay p {
      font-size: 14px;
      color: var(--accent);
    }

    #win {
      position: absolute;
      inset: 0;
      background: rgba(7, 10, 22, 0.95);
      backdrop-filter: blur(20px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    #win.hidden {
      display: none;
    }

    #win h2 {
      font-size: 64px;
      margin-bottom: 20px;
    }
  </style>
</head>

<body>
  <div class="shell">
    <div class="card">
      <div class="hud">
        <div class="title">‚üÅ PulseQuest</div>
        <div class="info">
          Pos: <span id="pos">1,1</span> | Dir: <span id="dir">E</span> | Steps: <span id="steps">0</span>
          <button class="menu-btn" onclick="toggleDrawer()" style="margin-left: 15px;">üó∫Ô∏è</button>
        </div>
      </div>

      <div class="stage" id="stage">
        <div class="compass">
          <div class="compass-inner">
            <div class="compass-arrow n" id="compass-n">‚ñ≤</div>
            <div class="compass-arrow e" id="compass-e">‚ñ∫</div>
            <div class="compass-arrow s" id="compass-s">‚ñº</div>
            <div class="compass-arrow w" id="compass-w">‚óÄ</div>
          </div>
        </div>
        <div id="grid"></div>
        <div class="tap-hint">Tap Left: Move ‚Ä¢ Tap Right: Turn</div>
      </div>

      <!-- Settings Drawer -->
      <div id="drawer" class="drawer">
        <div class="drawer-header">
          <h3>Settings</h3>
          <button class="close-btn" onclick="toggleDrawer()">√ó</button>
        </div>
        <div class="settings">
          <select id="mapSelect" onchange="loadMap()">
            <option value="0">Map: Empty</option>
            <option value="1">Map: Simple Maze</option>
            <option value="2">Map: Challenge</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div id="overlay">
    <h2>‚üÅ PulseQuest</h2>
    <p>Tap to begin</p>
  </div>

  <div id="win" class="hidden">
    <h2>üéâ</h2>
    <p>Treat found! Refresh to play again</p>
  </div>

  <script>
    // Game constants
    const WIDTH = 21;
    const HEIGHT = 7;
    const DIR = ['N', 'E', 'S', 'W'];
    const DX = [0, 1, 0, -1];
    const DY = [-1, 0, 1, 0];
    const COMPASS_IDS = ['compass-n', 'compass-e', 'compass-s', 'compass-w'];

    // Maps: E = Empty, W = Wall, B = Beacon
    const MAPS = [
      // Map 0: Empty
      "EEEEEEEEEEEEEEEEEEEEE,EEEEEEEEEEEEEEEEEEEEE,EEEEEEEEEEEEEEEEEEEEE,EEEEEEEEEEEEEEEEEEEEE,EEEEEEEEEEEEEEEEEEEEE,EEEEEEEEEEEEEEEEEBEEE,EEEEEEEEEEEEEEEEEEEEE",
      // Map 1: Simple Maze
      "WWWWWWWWWWWWWWWWWWWWW,WEEEEEWWWWWEEEEEEEWW,WEWWWEWWWWWEWWWWWEWW,WEWWWEEEEEEEWWWWWEWW,WEWWWWWWWWWWWEEEEEWW,WEEEEEEEEEEEEEWWWBEW,WWWWWWWWWWWWWWWWWWWWW",
      // Map 2: Challenge
      "WWWWWWWWWWWWWWWWWWWWW,WEEEEEWEEEWEEEEEEEEWW,WEWWWEWWWWWEWEWWWEWW,WEEWEWEEEEEEEWWWBEWW,WEWWWWWWWWWWWEEEWEWW,WEEEEEEEEEEEEEEEEEWW,WWWWWWWWWWWWWWWWWWWWW"
    ];

    // Game state
    let map = [];
    let px = 1, py = 1, pd = 1;
    let steps = 0;
    let started = false;
    let beaconX = 19, beaconY = 5;

    // Parse map string
    function parseMap(str) {
      return str.split(',').map(row => row.split(''));
    }

    // Get tile at position
    function getTile(x, y) {
      return (y >= 0 && y < HEIGHT && x >= 0 && x < WIDTH) ? map[y][x] : 'W';
    }

    // Render grid
    function render() {
      const grid = document.getElementById('grid');
      grid.innerHTML = '';

      for (let y = 0; y < HEIGHT; y++) {
        for (let x = 0; x < WIDTH; x++) {
          const cell = document.createElement('div');
          const tile = map[y][x];
          cell.className = 'cell';

          // Beacon
          if (tile === 'B') {
            cell.classList.add('beacon');
            cell.innerHTML = '<span class="icon">ü¶¥</span>';
          }
          // Wall
          else if (tile === 'W') {
            cell.classList.add('wall');
            cell.innerHTML = '<span class="icon">üß±</span>';
          }

          // Player
          if (x === px && y === py) {
            cell.innerHTML = '<span class="player">üêï</span>';
          }

          grid.appendChild(cell);
        }
      }

      // Update compass
      COMPASS_IDS.forEach((id, idx) => {
        const arrow = document.getElementById(id);
        if (arrow) {
          arrow.classList.toggle('active', idx === pd);
        }
      });

      // Update HUD
      document.getElementById('pos').textContent = `${px},${py}`;
      document.getElementById('dir').textContent = DIR[pd];
      document.getElementById('steps').textContent = steps;
    }

    // Move forward
    function moveForward() {
      if (!started) return;

      const newX = px + DX[pd];
      const newY = py + DY[pd];

      // Check bounds
      if (newX < 0 || newX >= WIDTH || newY < 0 || newY >= HEIGHT) return;

      // Check for wall
      const tile = getTile(newX, newY);
      if (tile === 'W') return;

      // Move player
      px = newX;
      py = newY;
      steps++;

      // Check win
      if (tile === 'B') {
        document.getElementById('win').classList.remove('hidden');
      }

      render();
    }

    // Turn right
    function turnRight() {
      if (!started) return;
      pd = (pd + 1) % 4;
      render();
    }

    // Load map
    function loadMap() {
      const mapIdx = parseInt(document.getElementById('mapSelect').value);
      map = parseMap(MAPS[mapIdx]);

      // Find beacon position
      for (let y = 0; y < HEIGHT; y++) {
        for (let x = 0; x < WIDTH; x++) {
          if (map[y][x] === 'B') {
            beaconX = x;
            beaconY = y;
          }
        }
      }

      // Reset player position
      px = 1;
      py = 1;
      pd = 1;
      steps = 0;
      document.getElementById('win').classList.add('hidden');
      render();
    }

    // Toggle drawer
    function toggleDrawer() {
      document.getElementById('drawer').classList.toggle('open');
    }

    // Touch controls (using proven logic from touch-test.html)
    const stageEl = document.getElementById('stage');
    const activePointers = new Map();

    function showFlash(x, y) {
      const flash = document.createElement('div');
      flash.className = 'input-flash';
      flash.style.left = x + 'px';
      flash.style.top = y + 'px';
      document.body.appendChild(flash);
      setTimeout(() => flash.remove(), 400);
    }

    stageEl.addEventListener('pointerdown', (e) => {
      if (!started) return;

      e.preventDefault();
      stageEl.setPointerCapture(e.pointerId);

      activePointers.set(e.pointerId, { x: e.clientX, y: e.clientY });
      showFlash(e.clientX, e.clientY);
    }, { passive: false });

    stageEl.addEventListener('pointerup', (e) => {
      if (!activePointers.has(e.pointerId)) return;

      try { stageEl.releasePointerCapture(e.pointerId); } catch { }

      const rect = stageEl.getBoundingClientRect();
      const mid = rect.left + rect.width / 2;
      const startX = activePointers.get(e.pointerId).x;

      activePointers.delete(e.pointerId);

      // Determine action based on which side was tapped
      if (startX < mid) {
        // Left side = Move
        moveForward();
      } else {
        // Right side = Turn
        turnRight();
      }
    });

    stageEl.addEventListener('pointercancel', (e) => {
      try { stageEl.releasePointerCapture(e.pointerId); } catch { }
      activePointers.delete(e.pointerId);
    });

    // Keyboard controls
    document.addEventListener('keydown', (e) => {
      if (e.key === 'w' || e.key === 'ArrowUp') moveForward();
      else if (e.key === 'd' || e.key === 'ArrowRight') turnRight();
    });

    // Start game
    function start() {
      document.getElementById('overlay').classList.add('hidden');
      started = true;
      loadMap();
    }

    document.getElementById('overlay').addEventListener('pointerdown', start);

    // Initialize
    loadMap();
  </script>
</body>

</html>