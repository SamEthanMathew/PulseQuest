<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="screen-orientation" content="landscape">
  <title>PulseQuest</title>
  <style>
    :root {
      --card: rgba(255, 255, 255, 0.06);
      --card2: rgba(255, 255, 255, 0.09);
      --stroke: rgba(255, 255, 255, 0.12);
      --text: rgba(255, 255, 255, 0.92);
      --muted: rgba(255, 255, 255, 0.65);
      --good: #2ee59d;
      --warn: #ff5c5c;
      --beacon: #ffd166;
      --accent: #6ca8ff;
      --empty: #0d2a3a;
      --wall: #151525;
      --hazard: #3a1515;
      --beaconBg: #2a2510;
      
      /* Safe area support for notched devices */
      --sat: env(safe-area-inset-top, 0px);
      --sar: env(safe-area-inset-right, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    /* Mobile-first optimizations */
    html, body {
      width: 100%;
      height: 100vh; /* Fallback */
      height: 100dvh; /* Dynamic viewport - handles address bar */
      margin: 0;
      padding: 0;
      overflow: hidden; /* Prevent scrolling during gameplay */
      position: fixed; /* Lock viewport */
      overscroll-behavior: none;
      touch-action: none; /* Prevent default gestures */
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none;
      user-select: none;
    }

    body {
      min-height: 100vh;
      min-height: 100dvh;
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(ellipse at 50% 30%, #0a1628 0%, #070A16 50%, #030508 100%)
    }

    .shell {
      max-width: 900px;
      width: 100%;
      height: 100vh;
      height: 100dvh;
      margin: 0 auto;
      padding: max(12px, var(--sat)) max(12px, var(--sar)) max(12px, var(--sab)) max(12px, var(--sal));
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      overflow: hidden;
      touch-action: manipulation;
      -webkit-user-select: none;
      user-select: none;
    }

    .card {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0; /* Allow flex shrinking */
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 20px;
      box-shadow: 0 20px 70px rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(12px);
      overflow: hidden
    }

    /* HUD */
    .hud {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      border-bottom: 1px solid var(--stroke)
    }

    .hud .title {
      font-weight: 800;
      font-size: 18px;
      color: var(--beacon)
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: var(--card2);
      color: var(--muted);
      font-size: 12px
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--warn)
    }

    .dot.ok {
      background: var(--good);
      box-shadow: 0 0 12px rgba(46, 229, 157, 0.6);
      animation: pulse 2s infinite
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: 0.5
      }
    }

    .chips {
      display: flex;
      gap: 6px
    }

    /* Objective */
    .objective {
      text-align: center;
      padding: 10px;
      font-size: 14px;
      color: var(--muted);
      border-bottom: 1px solid var(--stroke)
    }

    .objective strong {
      color: var(--beacon);
      font-size: 16px
    }

    /* Stage */
    .stage {
      flex: 1;
      min-height: 0;
      padding: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden
    }

    #grid {
      display: grid;
      grid-template-columns: repeat(21, 1fr);
      gap: 1px;
      padding: 6px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 12px;
      border: 1px solid var(--stroke);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      position: relative;
      max-width: 100%;
      aspect-ratio: 21 / 7
    }

    .cell {
      width: 100%;
      aspect-ratio: 1;
      max-width: 36px;
      max-height: 36px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      transition: all 0.3s;
      border: 1px solid transparent
    }

    /* Tile types with icons */
    .cell.E {
      background: var(--empty);
      border-color: rgba(46, 229, 157, 0.12)
    }

    .cell.W {
      background: var(--wall);
      border-color: rgba(255, 255, 255, 0.08);
      background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(255, 255, 255, 0.03) 5px, rgba(255, 255, 255, 0.03) 10px)
    }

    .cell.H {
      background: var(--hazard);
      border-color: rgba(255, 92, 92, 0.25)
    }

    .cell.B {
      background: var(--beaconBg);
      border-color: rgba(255, 209, 102, 0.35)
    }

    /* Icons */
    .icon {
      font-size: 18px;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
      transition: opacity 0.3s
    }

    .cell.fog .icon {
      opacity: 0.08
    }

    .cell.W .icon {
      opacity: 0.4
    }

    /* Player glow - always visible */
    .player {
      font-size: 20px;
      color: #fff;
      filter: drop-shadow(0 0 8px var(--accent)) drop-shadow(0 0 16px var(--accent));
      z-index: 5;
      animation: playerGlow 1.5s infinite
    }

    @keyframes playerGlow {

      0%,
      100% {
        filter: drop-shadow(0 0 12px var(--accent)) drop-shadow(0 0 24px var(--accent))
      }

      50% {
        filter: drop-shadow(0 0 18px var(--accent)) drop-shadow(0 0 36px var(--accent))
      }
    }

    /* Beacon pulse - intense */
    .cell.B::after {
      content: "";
      position: absolute;
      inset: -4px;
      border-radius: 14px;
      box-shadow: 0 0 30px rgba(255, 209, 102, 0.7), 0 0 60px rgba(255, 209, 102, 0.4), inset 0 0 20px rgba(255, 209, 102, 0.3);
      animation: beaconPulse 0.8s infinite;
      pointer-events: none
    }

    @keyframes beaconPulse {

      0%,
      100% {
        opacity: 0.5;
        transform: scale(0.95);
        box-shadow: 0 0 30px rgba(255, 209, 102, 0.7), 0 0 60px rgba(255, 209, 102, 0.4)
      }

      50% {
        opacity: 1;
        transform: scale(1.08);
        box-shadow: 0 0 50px rgba(255, 209, 102, 1), 0 0 100px rgba(255, 209, 102, 0.6), 0 0 150px rgba(255, 209, 102, 0.3)
      }
    }

    /* Hazard shimmer */
    .cell.H::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 10px;
      background: radial-gradient(circle at 30% 30%, rgba(255, 100, 100, 0.2), transparent 50%), radial-gradient(circle at 70% 70%, rgba(255, 100, 100, 0.15), transparent 40%);
      animation: hazardShimmer 0.8s infinite alternate
    }

    @keyframes hazardShimmer {
      0% {
        opacity: 0.5
      }

      100% {
        opacity: 1
      }
    }

    /* Fog */
    .cell.fog {
      opacity: 0.15;
      filter: blur(2px)
    }

    .cell.scan {
      animation: scanFlash 0.6s
    }

    @keyframes scanFlash {
      0% {
        box-shadow: 0 0 0 4px var(--accent), 0 0 20px var(--accent)
      }

      100% {
        box-shadow: none
      }
    }

    /* Ping ring */
    .ping {
      position: absolute;
      border-radius: 50%;
      border: 2px solid var(--accent);
      opacity: 0;
      pointer-events: none;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%)
    }

    .ping.active {
      animation: pingExpand 0.8s ease-out forwards
    }

    @keyframes pingExpand {
      0% {
        width: 30px;
        height: 30px;
        opacity: 0.9
      }

      100% {
        width: 280px;
        height: 280px;
        opacity: 0
      }
    }

    /* Haptic strip */
    #haptics {
      height: 24px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 6px;
      display: flex;
      gap: 2px;
      padding: 3px;
      width: 100%;
      max-width: 380px;
      border: 1px solid var(--stroke)
    }

    .hpulse {
      flex: 0 0 32px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      transition: all 0.15s
    }

    .hpulse.on {
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent)
    }

    /* Controls dock */
    .controls {
      padding: 8px 12px;
      border-top: 1px solid var(--stroke);
      flex-shrink: 0
    }

    .dock {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
      padding: 8px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      border: 1px solid var(--stroke)
    }

    .btn {
      min-width: 70px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(255, 255, 255, 0.07);
      color: var(--text);
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.12s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      touch-action: manipulation
    }

    .btn:hover {
      background: rgba(255, 255, 255, 0.12);
      box-shadow: 0 0 0 2px rgba(108, 168, 255, 0.25)
    }

    .btn:active {
      transform: scale(0.96);
      background: rgba(108, 168, 255, 0.2)
    }

    .btn small {
      font-size: 10px;
      color: var(--muted);
      font-weight: 400
    }

    .btn-group {
      display: flex;
      gap: 6px
    }

    /* Settings row */
    .settings {
      display: flex;
      gap: 8px;
      justify-content: center;
      padding: 12px;
      flex-wrap: wrap
    }

    .settings label,
    .settings select,
    .settings button {
      font-size: 12px;
      color: var(--muted);
      background: var(--card2);
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--stroke);
      cursor: pointer
    }

    .settings input {
      margin-right: 4px
    }

    /* Prevent iOS zoom on input focus */
    input, select, button {
      font-size: 16px !important
    }

    /* Training drawer */
    #train {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s
    }

    #train.open {
      max-height: 100px
    }

    .train-inner {
      padding: 12px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: center;
      border-top: 1px solid var(--stroke)
    }

    .train-inner button {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--stroke);
      background: var(--card2);
      color: var(--text);
      cursor: pointer;
      font-size: 12px
    }

    .train-inner p {
      width: 100%;
      text-align: center;
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px
    }

    /* Overlay */
    #overlay {
      position: fixed;
      inset: 0;
      background: rgba(7, 10, 22, 0.92);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100
    }

    #overlay h2 {
      color: var(--beacon);
      font-size: 32px;
      margin-bottom: 12px;
      text-shadow: 0 0 40px rgba(255, 209, 102, 0.5)
    }

    #overlay .subtitle {
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--text)
    }

    #overlay p {
      color: var(--muted);
      font-size: 14px
    }

    #overlay.hidden {
      display: none
    }

    /* Win screen */
    #win {
      position: fixed;
      inset: 0;
      background: rgba(7, 10, 22, 0.97);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100
    }

    #win h2 {
      color: var(--beacon);
      font-size: 56px;
      text-shadow: 0 0 50px rgba(255, 209, 102, 0.6);
      animation: beaconPulse 1s infinite
    }

    #win p {
      color: var(--muted);
      margin-top: 16px;
      font-size: 16px
    }

    #win.hidden {
      display: none
    }

    /* Landscape mode optimization (primary layout) */
    @media (orientation: landscape) {
      .shell {
        padding: 8px;
        flex-direction: row
      }

      .card {
        flex-direction: row
      }

      .hud {
        writing-mode: vertical-rl;
        text-orientation: mixed;
        padding: 8px 6px;
        border-bottom: none;
        border-right: 1px solid var(--stroke);
        min-width: 60px
      }

      .hud .title {
        font-size: 14px
      }

      .chips {
        flex-direction: column;
        gap: 8px
      }

      .pill {
        font-size: 10px;
        padding: 4px 6px
      }

      .objective {
        position: absolute;
        top: 8px;
        left: 70px;
        right: 8px;
        border-bottom: none;
        padding: 6px;
        font-size: 11px;
        background: var(--card);
        border-radius: 8px;
        z-index: 10
      }

      .objective strong {
        font-size: 12px
      }

      .stage {
        flex: 1;
        padding: 4px;
        padding-top: 40px
      }

      #grid {
        max-width: 90%;
        max-height: 90%
      }

      .controls {
        writing-mode: vertical-rl;
        text-orientation: mixed;
        padding: 8px 6px;
        border-top: none;
        border-left: 1px solid var(--stroke);
        min-width: 70px
      }

      .dock {
        flex-direction: column;
        padding: 6px;
        gap: 4px
      }

      .btn {
        min-width: 50px;
        padding: 8px 6px;
        font-size: 11px;
        writing-mode: horizontal-tb
      }

      .tap-hint {
        writing-mode: horizontal-tb;
        transform: rotate(90deg);
        transform-origin: center;
        margin-top: 0;
        margin-left: 10px;
        font-size: 9px
      }

      .settings {
        flex-direction: column;
        padding: 4px;
        gap: 4px
      }

      .settings label, .settings select, .settings button {
        font-size: 10px;
        padding: 4px 6px;
        writing-mode: horizontal-tb
      }

      #train {
        max-height: 0
      }

      #train.open {
        max-height: 200px
      }
    }

    /* Portrait mode (fallback) */
    @media (orientation: portrait) {
      .objective strong {
        font-size: 14px
      }
    }

    /* Small height optimization (works in both orientations) */
    @media (max-height: 450px) {
      .shell {
        padding: 4px
      }
      
      .hud {
        padding: 6px 8px;
        font-size: 12px
      }

      .hud .title {
        font-size: 12px
      }
      
      .objective {
        padding: 4px;
        font-size: 10px
      }

      .objective strong {
        font-size: 11px
      }
      
      .stage {
        padding: 2px
      }
      
      #grid {
        padding: 3px;
        gap: 1px
      }
      
      .cell {
        border-radius: 2px
      }
      
      .icon {
        font-size: 12px
      }
      
      .controls {
        padding: 4px 6px
      }
      
      .dock {
        gap: 3px;
        padding: 4px
      }
      
      .btn {
        min-width: 45px;
        padding: 6px 8px;
        font-size: 10px
      }
      
      .settings {
        padding: 4px;
        gap: 3px
      }
      
      .settings label, .settings select, .settings button {
        font-size: 9px;
        padding: 3px 6px
      }
    }

    /* Prevent text selection during touch */
    .stage, .grid, .cell, .dock, .btn {
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none
    }
  </style>
</head>

<body>
  <!-- Debug viewport info (toggle with Shift+D) -->
  <div id="debug" style="display:none; position:fixed; top:0; left:0; background:rgba(0,0,0,0.9); color:#0f0; font-family:monospace; font-size:10px; padding:8px; z-index:999; max-width:200px; line-height:1.3; pointer-events:none;">
    <div id="debug-content"></div>
  </div>

  <div class="shell">
    <div class="card">
      <div class="hud">
        <span class="title">‚üÅ PulseQuest</span>
        <div class="chips">
          <span class="pill">‚öì <strong id="steps">0</strong> steps</span>
        </div>
      </div>
      <div class="objective"><strong>üóº Find the Beacon</strong> ‚Äî Navigate by touch</div>
      <div class="stage">
        <div id="grid"></div>
        <div class="ping" id="ping"></div>

      </div>
      <div class="controls">
        <div class="dock">
          <button class="btn" onclick="act('M')">‚õµ Move<small>Tap Left</small></button>
          <button class="btn" onclick="act('R')">‚ü≥ Turn<small>Tap Right</small></button>
        </div>
        <div class="tap-hint" style="text-align: center; font-size: 10px; color: var(--muted); opacity: 0.5; margin-top: 4px;">
          Left: Move ‚Ä¢ Right: Turn ‚Ä¢ Both: Scan
        </div>
        <div class="settings">
          <label><input type="checkbox" id="specV" checked onchange="render()">Spectator</label>
          <label><input type="checkbox" id="demoM" onchange="togDemo()">Demo</label>
          <label><input type="checkbox" id="muteAudio" onchange="setVolume(this.checked?0:0.4)">Mute</label>
          <select id="lvl" onchange="loadLvl()">
            <option value="0">Tutorial</option>
            <option value="1">Hazards</option>
            <option value="2">Challenge</option>
          </select>
          <button onclick="togTrain()">Training</button>
        </div>
        <div id="train">
          <div class="train-inner">
            <button onclick="hapticImpact('light');playMove()">üåä Empty</button>
            <button onclick="hapticNotify('error');playWall()">üß± Wall</button>
            <button onclick="hapticNotify('success');playWin()">üóº Beacon</button>
            <button onclick="playSonar()">üì° Sonar</button>
            <p>Test haptic + audio feedback</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="overlay" onclick="start()" ontouchend="start()">
    <h2>‚üÅ PulseQuest</h2>
    <div class="subtitle">‚õµ Navigate ‚Ä¢ üóº Find beacon</div>
    <p>Tap to begin ‚Ä¢ Left=Move ‚Ä¢ Right=Turn ‚Ä¢ Both=Scan</p>
  </div>
  <div id="win" class="hidden">
    <h2>üèÜ</h2>
    <p>Beacon found! Press Enter to play again</p>
  </div>

  <script src="js/no-network-guard.js"></script>
  <script src="js/haptics.js"></script>
  <script src="js/audio.js"></script>

  <script>
    const LEVELS = [
      "WWWWWWWWWWWWWWWWWWWWW,WEEEEEWWWWWEEEEEEEWW,WEWWWEWWWWWEWWWWWEWW,WEWWWEEEEEEEWWWWWEWW,WEWWWWWWWWWWWEEEEEWW,WEEEEEEEEEEEEEWWWBEW,WWWWWWWWWWWWWWWWWWWWW",
      "WWWWWWWWWWWWWWWWWWWWW,WEEEEEWEEEWEEEEEEEEWW,WEWWWEWWWWWEWWWWWEWW,WEWWWEEEEEEEWWWWWEWW,WEWWWWWWWWWWWEEEEEWW,WEEEEEEEEEEEEEWWWBEW,WWWWWWWWWWWWWWWWWWWWW",
      "WWWWWWWWWWWWWWWWWWWWW,WEEEEEWEEEWEEEEEEEEWW,WEWWWEWWWWWEWEWWWEWW,WEEWEWEEEEEEEWWWBEWW,WEWWWWWWWWWWWEEEWEWW,WEEEEEEEEEEEEEEEEEWW,WWWWWWWWWWWWWWWWWWWWW"
    ];
    const DIR = ['N', 'E', 'S', 'W'], DX = [0, 1, 0, -1], DY = [-1, 0, 1, 0], ARR = ['‚ñ≤', '‚ñ∫', '‚ñº', '‚óÄ'];
    const ICONS = { E: '', W: 'üß±', B: 'üóº' };
    let map, px, py, pd, steps, lastScan, started = false;

    function parse(s) { return s.split(',').map(r => r.split('')) }
    function loadLvl() {
      const i = +document.getElementById('lvl').value;
      map = parse(LEVELS[i]); px = 1; py = 1; pd = 1; steps = 0; lastScan = null;
      document.getElementById('win').classList.add('hidden');
      render(); updStats();
    }
    function tile(x, y) { return (y >= 0 && y < 7 && x >= 0 && x < 21) ? map[y][x] : 'W' }
    function ahead() { return { x: px + DX[pd], y: py + DY[pd] } }
    function leftT() { const d = (pd + 3) % 4; return { x: px + DX[d], y: py + DY[d] } }
    function rightT() { const d = (pd + 1) % 4; return { x: px + DX[d], y: py + DY[d] } }

    function render() {
      const g = document.getElementById('grid'), spec = document.getElementById('specV').checked;
      g.innerHTML = '';
      for (let y = 0; y < 7; y++)for (let x = 0; x < 21; x++) {
        const c = document.createElement('div');
        const t = map[y][x];
        c.className = 'cell ' + t;
        const dist = Math.abs(x - px) + Math.abs(y - py);
        if (!spec && dist > 2) c.classList.add('fog');

        // Add icon
        if (x === px && y === py) {
          c.innerHTML = `<span class="player">${ARR[pd]}</span>`;
        } else if (ICONS[t]) {
          c.innerHTML = `<span class="icon">${ICONS[t]}</span>`;
        }
        g.appendChild(c);
      }
    }
    function updStats() {
      document.getElementById('steps').textContent = steps;
    }
    function flash(coords) {
      const cells = document.querySelectorAll('.cell');
      coords.forEach(([x, y]) => { if (x >= 0 && x < 21 && y >= 0 && y < 7) cells[y * 21 + x].classList.add('scan') });
      // Ping animation
      const ping = document.getElementById('ping');
      ping.classList.remove('active');
      void ping.offsetWidth;
      ping.classList.add('active');
      setTimeout(() => { cells.forEach(c => c.classList.remove('scan')) }, 600);
    }



    function act(a) {
      if (!started) return;
      if (a === 'M') {
        const { x, y } = ahead(), t = tile(x, y);
        if (t === 'W') { hapticNotify('error'); playWall(); return; }
        px = x; py = y; steps++;
        if (t === 'E') { hapticImpact('light'); playMove(); }
        if (t === 'B') { hapticNotify('success'); playWin(); document.getElementById('win').classList.remove('hidden'); }
      } else if (a === 'L') { pd = (pd + 3) % 4; hapticSelection(); playTurn(); }
      else if (a === 'R') { pd = (pd + 1) % 4; hapticSelection(); playTurn(); }
      else if (a === 'S') {
        const f = tile(ahead().x, ahead().y), l = tile(leftT().x, leftT().y), r = tile(rightT().x, rightT().y);
        lastScan = { f, l, r };
        hapticImpact('medium'); playSonar();
        flash([[ahead().x, ahead().y], [leftT().x, leftT().y], [rightT().x, rightT().y]]);
      } else if (a === 'P') {
        hapticImpact('light'); playSonar();
      }
      render(); updStats();
    }

    function start() { document.getElementById('overlay').classList.add('hidden'); started = true; loadLvl(); }
    function togTrain() { document.getElementById('train').classList.toggle('open'); }
    function togDemo() {
      const d = document.getElementById('demoM').checked;
      document.getElementById('specV').checked = d;
      document.querySelector('.objective').innerHTML = d ? '<strong style="font-size:22px">Press SCAN ‚Üí then MOVE</strong>' : '<strong>üóº Find the Beacon</strong> ‚Äî Navigate by touch';
      render();
    }

    // Distance scan with logarithmic vibration
    function performDistanceScan() {
      let beaconX = 19;
      let beaconY = 5;
      
      // Find actual beacon position
      for (let y = 0; y < 7; y++) {
        for (let x = 0; x < 21; x++) {
          if (map[y][x] === 'B') {
            beaconX = x;
            beaconY = y;
            break;
          }
        }
      }
      
      // Calculate straight-line distance (hypotenuse)
      const dx = beaconX - px;
      const dy = beaconY - py;
      const distance = Math.sqrt(dx * dx + dy * dy);
      
      // Logarithmic vibration: closer = longer buzz
      // Max distance ~25 units, map to 100-800ms range
      const maxDist = 25;
      const minVibDuration = 100;  // Very far = short buzz
      const maxVibDuration = 800;  // Very close = long buzz
      
      // Inverse logarithmic mapping (closer = more vibration)
      const normalizedDist = Math.min(distance / maxDist, 1);
      const vibDuration = maxVibDuration - (Math.log(1 + normalizedDist * 9) / Math.log(10)) * (maxVibDuration - minVibDuration);
      
      // Visual flash effect
      flash([[px, py]]);
      
      // Haptic feedback
      if (navigator.vibrate) {
        navigator.vibrate(Math.round(vibDuration));
      } else {
        // Audio fallback
        hapticImpact('medium');
      }
      
      // Optional: Audio ping
      playSonar();
      
      console.log(`Distance to beacon: ${distance.toFixed(1)} units, vibration: ${Math.round(vibDuration)}ms`);
    }

    // Tap zone controls: Left half = Move, Right half = Turn, Both = Scan
    let leftTouch = false;
    let rightTouch = false;
    let touchTimeout = null;

    document.addEventListener('touchstart', e => {
      if (!started) {
        // Allow overlay click to start game
        if (e.target.closest('#overlay')) {
          return;
        }
        return;
      }
      e.preventDefault();
      
      Array.from(e.touches).forEach(touch => {
        const x = touch.clientX;
        const isLeft = x < window.innerWidth / 2;
        
        if (isLeft) leftTouch = true;
        else rightTouch = true;
      });
      
      // Check for two-finger hold (scan)
      if (leftTouch && rightTouch) {
        clearTimeout(touchTimeout);
        touchTimeout = setTimeout(() => {
          performDistanceScan();
        }, 200); // 200ms hold to trigger scan
      }
    }, { passive: false });

    document.addEventListener('touchend', e => {
      if (!started) {
        // Allow overlay click to start game
        if (e.target.closest('#overlay')) {
          return;
        }
        return;
      }
      e.preventDefault();
      
      clearTimeout(touchTimeout);
      
      // Single tap actions (only if not both)
      if (leftTouch && !rightTouch) {
        act('M'); // Move forward
      } else if (rightTouch && !leftTouch) {
        act('R'); // Turn right (90¬∞ clockwise)
      }
      
      // Reset touch states
      leftTouch = false;
      rightTouch = false;
    }, { passive: false });

    // Cancel on touch cancel
    document.addEventListener('touchcancel', () => {
      clearTimeout(touchTimeout);
      leftTouch = false;
      rightTouch = false;
    });

    document.addEventListener('keydown', e => {
      // Toggle debug with Shift+D
      if (e.key === 'D' && e.shiftKey) {
        debugVisible = !debugVisible;
        debugEl.style.display = debugVisible ? 'block' : 'none';
        if (debugVisible) updateDebug();
        return;
      }
      
      if (e.key === 'Enter') { if (!started) start(); else loadLvl(); return; }
      const k = { w: 'M', arrowup: 'M', a: 'L', arrowleft: 'L', d: 'R', arrowright: 'R', s: 'S', shift: 'S', r: 'P' }[e.key.toLowerCase()];
      if (k) act(k);
    });

    // Viewport debug readout (Shift+D to toggle)
    let debugVisible = false;
    const debugEl = document.getElementById('debug');
    const debugContent = document.getElementById('debug-content');

    function updateDebug() {
      if (!debugVisible) return;
      
      const getInset = (side) => {
        const val = getComputedStyle(document.documentElement)
          .getPropertyValue(`--sa${side}`);
        return val || '0px';
      };
      
      debugContent.innerHTML = `
W: ${window.innerWidth}px
H: ${window.innerHeight}px
DPR: ${window.devicePixelRatio}
Orient: ${screen.orientation?.type || 'unknown'}
SAT: ${getInset('t')}
SAR: ${getInset('r')}
SAB: ${getInset('b')}
SAL: ${getInset('l')}
Grid: ${document.getElementById('grid')?.offsetWidth || 0}√ó${document.getElementById('grid')?.offsetHeight || 0}
      `.trim();
    }

    // Update debug on resize
    window.addEventListener('resize', updateDebug);
    window.addEventListener('orientationchange', () => {
      setTimeout(updateDebug, 300); // Wait for layout
    });

    loadLvl();
  </script>
</body>

</html>